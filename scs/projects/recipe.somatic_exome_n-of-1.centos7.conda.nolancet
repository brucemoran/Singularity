Bootstrap:library
From:bruce.moran/default/variant_callers:manta-strelka2.centos7

%environment

    source /opt/miniconda/etc/profile.d/conda.sh
    conda activate somatic_exome_n-of-1

%post

    ##conda
    wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
    bash ./miniconda.sh -b -p /opt/miniconda
    rm -rf miniconda.sh
    export CONDA_PKGS_PATH=/opt/miniconda/pkgs
    export CONDA_ENVS_PATH=/opt/miniconda/envs
    source /opt/miniconda/etc/profile.d/conda.sh
    export PATH="/opt/miniconda/bin:$PATH"

    ##conda env
    git clone https://github.com/brucemoran/somatic_exome_n-of-1
    cd somatic_exome_n-of-1
    conda env create -n somatic_exome_n-of-1 -f environment.yaml
    conda clean -y -a
    rm -rf somatic_exome_n-of-1

    ##compile snp-pileup
    ldconfig $CONDA_ENVS_PATH/somatic_exome_n-of-1/lib
    g++ -std=c++11 -o $CONDA_ENVS_PATH/somatic_exome_n-of-1/lib/R/library/facets/extcode/snp-pileup $CONDA_ENVS_PATH/somatic_exome_n-of-1/lib/R/library/facets/extcode/snp-pileup.cpp

    ##linking
    ln -sf /opt/miniconda/envs/somatic_exome_n-of-1/lib/* /usr/lib64/
    ln -s $CONDA_ENVS_PATH/somatic_exome_n-of-1/lib/R/library/facets/extcode/snp-pileup /usr/local/bin/snp-pileup

    ##liftover
    chmod +x $CONDA_ENVS_PATH/somatic_exome_n-of-1/bin/liftOver

    ##build loftee
    tar -xf /opt/miniconda/envs/somatic_exome_n-of-1/share/loftee/*

    ##set env vars
    echo -e "export PATH=/usr/local/bin:/opt/miniconda/envs/somatic_exome_n-of-1/bin:\$PATH\nexport LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:/opt/miniconda/envs/somatic_exome_n-of-1/lib:/opt/miniconda/envs/somatic_exome_n-of-1/lib64:/usr/local/lib:/usr/local/htslib:/usr/lib64:/bin\nexport PERL5LIB=/opt/miniconda/envs/somatic_exome_n-of-1/share" >> /.singularity.d/env/99-base.sh
