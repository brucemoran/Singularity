Bootstrap:library
From:bruce.moran/default/bases:centos7_conda

%environment

    source /opt/miniconda/etc/profile.d/conda.sh
    conda activate somatic_exome_n-of-1_py3

%post

    export PATH=/opt/miniconda/bin:$PATH

    ##conda env for py3 packages
    git clone https://github.com/brucemoran/somatic_exome_n-of-1
    conda env create -n somatic_exome_n-of-1_py3 -f somatic_exome_n-of-1/environment.yaml
    conda install --name somatic_exome_n-of-1_py3 -c ohsu-comp-bio lancet
    conda clean -y -a
    conda env create -n somatic_exome_n-of-1_py2 -f somatic_exome_n-of-1/environment.2.yaml
    conda clean -y -a
    rm -rf /opt/somatic_exome_n-of-1

    ##compile snp-pileup
    g++ -std=c++11 -I $CONDA_ENVS_PATH/somatic_exome_n-of-1_py3/include $CONDA_ENVS_PATH/somatic_exome_n-of-1_py3/lib/R/library/facets/extcode/snp-pileup.cpp -L$CONDA_ENVS_PATH/somatic_exome_n-of-1_py3/include -lhts -Wl,-rpath=$CONDA_ENVS_PATH/somatic_exome_n-of-1_py3/include -o $CONDA_ENVS_PATH/somatic_exome_n-of-1_py3/lib/R/library/facets/extcode/snp-pileup

    ##linking
    ln -sf /opt/miniconda/envs/somatic_exome_n-of-1_py3/lib/*.s* /usr/lib64/
    ln -s $CONDA_ENVS_PATH/somatic_exome_n-of-1_py3/lib/R/library/facets/extcode/snp-pileup /usr/local/bin/snp-pileup

    ##liftover
    chmod +x $CONDA_ENVS_PATH/somatic_exome_n-of-1_py3/bin/liftOver
